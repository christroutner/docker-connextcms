# docker-connextcms
A Dockerfile used to create a Docker Image for running ConnextCMS and KeystoneJS in a Docker Container

This repository contains two Dockerfiles. The one in this root directory will create a Docker image
with a functional version of ConnextCMS and KeystoneJS. It depends on the official `mongo` Docker image,
and a repository of pre-compiled KeystoneJS code generated by the second Docker image below.
Instructions for running the image are in the top of the Dockerfile.

A second Dockerfile exists in the `buildFromSource` directory. This creates an environment ready to run
the `yo keystone` command to build KeystoneJS from scratch. This environment is used to create and update
the [keystone4-compiled](https://github.com/christroutner/keystone4-compiled) repository used by first 
Dockerfile.

The Dockerfiles assume that the MongoDB containerhas it's internal port 27017 mapped to host port 3500.

## Installation
It's assumed that you are starting with a fresh installation of Ubuntu 16.04 LTS on a 64-bit machine. 
It's also assumed that you are installing as a [non-root user with sudo privileges](https://www.digitalocean.com/community/tutorials/initial-server-setup-with-ubuntu-16-04). 

1. Install Docker on the host system. [This tutorial](https://www.digitalocean.com/community/tutorials/how-to-install-and-use-docker-on-ubuntu-16-04)
shows how to install Docker on a Ubuntu 16.04 system. It's specifically targeted to Digital Ocean's cloud servers.
Use [this link](https://m.do.co/c/8f47a23b91ce) to sign up for a Digital Ocean account and get a $10 credit, capable of
running a $5 server for two months.


2. Clone this repository. It's assumed from here on out that you're using your home directory, aliased with `~`:

```
cd
git clone https://github.com/christroutner/docker-connextcms
```

3. Pull the MongoDB docker image by running this command:

`docker pull mongo`


4. Run the MongoDB image with its port 27017 mapped to the host port of 3500. Replace `<your path>`
with an absolute directory path to a folder where you want DB data to be persisted. For example,
`~/docker-connextcms/db` is a good path, assuming you cloned this repository in your home directory.

`docker run --name mongo -d -p 3500:27017 --rm -v <your path>/db:/data/db mongo`


5. Build the ConnextCMS/KeystoneJS Docker image:

```
cd docker-connextcms
docker build -t connextcms .
```


6. Run the ConnextCMS/KeystoneJS image. Again, replace `<your path>` with an appropriate path, like
`~/docker-connextcms/`. The theme directory is where you would store your site-specific files like
index.hbs or default.hbs and any API files. This is where you would clone the 
[ConnextCMS Site Template](https://github.com/skagitpublishing/site-template-connextcms), 
or if you're more ambitious, the 
[ConnextCMS Plugin Template](https://github.com/skagitpublishing/plugin-template-connextcms).

`docker container run --name connextcms -v <your path>/theme:/home/connextcms/theme --link mongo:mongo -p 3000:3000 --rm -it connextcms bash`

This will open a bash shell within the Docker container. You will be automatically logged in as user 'connextcms' with sudo
privileges and a password of 'password'. 


7. Run KeystoneJS with the following commands:

```
cd myCMS
node keystone.js &
```

KeystoneJS will now be running on port 3000, with ConnextCMS running with it.

